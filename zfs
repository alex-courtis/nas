#
# creation
#

# disk ids
ls /dev/disk/by-id/ | grep "ata-"

# show block size
# most SSDs show 512 however
#  AW states that it's unreliable
#  zfs doc agrees
# so use ashift=12
blockdev --getpbsz /dev/sda

# create pool
zpool create \
	-f \
	-m /srv/nfs \
	-o ashift=12 \
	pool \
	raidz \
	ata-Samsung_SSD_870_QVO_8TB_S5SSNF0WA05324A \
	ata-Samsung_SSD_870_QVO_8TB_S5SSNF0WA05327T \
	ata-Samsung_SSD_870_QVO_8TB_S5SSNF0WA05350J \
	ata-Samsung_SSD_870_QVO_8TB_S5SSNF0WA05377P

# show history
zpool history

# verify pool status
zpool status -v

# datasets don't add value

# no need to set the cache file, default is below
#zpool set cachefile=/etc/zfs/zpool.cache pool

# AW advises against zfs-mount due to load order issues, use zfs-mount-generator
mkdir /etc/zfs/zfs-list.cache

# enable services
systemctl enable zfs.target
systemctl enable zfs-zed.service
systemctl start zfs-zed.service

# create the file for zedlet to write the FS list
touch /etc/zfs/zfs-list.cache/pool

# nudge it into action
zfs set canmount=off pool
zfs set canmount=on pool
cat /etc/zfs/zfs-list.cache/pool

# do the first import
zfs mount -a

# enable auto mounts
systemctl enable zfs-import.target
systemctl enable zfs-import-cache.service

# reboot to ensure everything mounts automatically

# enable periodic trimming
zpool set autotrim=on pool

# trim now
zpool trim pool
zpool status -t pool

# also enable trim timer, as occasional trims are recommended by AW
systemctl enable zfs-trim@pool.timer

# monthly scrubbing
systemctl enable zfs-scrub@pool.timer

# scrub now
systemctl start zfs-scrub@pool.timer

#
# enable nfs
#
systemctl enable nfs-server.service
systemctl enable zfs-share.service
systemctl start nfs-server.service
systemctl start zfs-share.service

# nfs4 root
zfs set sharenfs="rw=@10.0.0.0/8,fsid=root" pool

# show
exportfs -v
showmount -e lord
zfs get sharenfs





# disable/stop all services
systemctl disable nfs-server.service
systemctl stop nfsdcld.service
systemctl stop nfs-server.service

systemctl disable zfs.target
systemctl disable zfs-zed.service
systemctl disable zfs-import.target
systemctl disable zfs-import-cache.service
systemctl disable zfs-share.service

systemctl stop zfs.target
systemctl stop zfs-zed.service
systemctl stop zfs-import.target
systemctl stop zfs-import-cache.service
systemctl stop zfs-share.service

# vim:ft=sh

